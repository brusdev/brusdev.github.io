<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=/themify-icons/themify-icons.css><link rel=stylesheet href=/main.bc2833cdf63d3b816b4aa8e212050beb6e65aba150d53a6d0753d7dc9682b0a3a9f84b58efecb08ff350d44a3945d0c61afa53284731a7cf7c886fec2af8fb57.css integrity="sha512-vCgzzfY9O4FrSqjiEgUL625lq6FQ1TptB1PX3JaCsKOp+EtY7+ywj/NQ1Eo5RdDGGvpTKEcxp898iG/sKvj7Vw==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Scaling Up and Down Brokers with ArtemisCloud Operator - ArtemisCloud.io</title><meta name=description content="How to use operator to scale up and down broker pods"><link rel=canonical href=/blog/scaling-up-and-down-brokers-with-artemiscloud-operator/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Scaling Up and Down Brokers with ArtemisCloud Operator"><meta property="og:description" content="How to use operator to scale up and down broker pods"><meta property="og:url" content="/blog/scaling-up-and-down-brokers-with-artemiscloud-operator/"><meta property="og:site_name" content="ArtemisCloud.io"><meta property="article:published_time" content="2021-02-04T00:00:00+00:00"><meta property="article:modified_time" content="2021-02-18T00:00:00+00:00"><meta property="og:image" content="/artemiscloud.png"><meta property="og:image:alt" content="ArtemisCloud.io"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@artemiscloudio"><meta name=twitter:creator content="@henkverlinde"><meta name=twitter:title content="Scaling Up and Down Brokers with ArtemisCloud Operator"><meta name=twitter:description content="How to use operator to scale up and down broker pods"><meta name=twitter:image content="/artemiscloud.png"><meta name=twitter:image:alt content="Scaling Up and Down Brokers with ArtemisCloud Operator"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"/#/schema/organization/1","name":"ArtemisCloud.io","url":"/","sameAs":["https://twitter.com/artemiscloudio","https://github.com/artemiscloud"],"logo":{"@type":"ImageObject","@id":"/#/schema/image/1","url":"/artemiscloud.png","width":512,"height":512,"caption":"ArtemisCloud.io"},"image":{"@id":"/#/schema/image/1"}},{"@type":"WebSite","@id":"/#/schema/website/1","url":"/","name":"ArtemisCloud.io","description":"ArtemisCloud.io is a collection of container images that provide a way to deploy the Apache ActiveMQ Artemis Broker on Kubernetes.","publisher":{"@id":"/#/schema/organization/1"}},{"@type":"WebPage","@id":"/blog/scaling-up-and-down-brokers-with-artemiscloud-operator/","url":"/blog/scaling-up-and-down-brokers-with-artemiscloud-operator/","name":"Scaling Up and Down Brokers with ArtemisCloud Operator","description":"How to use operator to scale up and down broker pods","isPartOf":{"@id":"/#/schema/website/1"},"about":{"@id":"/#/schema/organization/1"},"datePublished":"2021-02-04T00:00:00CET","dateModified":"2021-02-18T00:00:00CET","breadcrumb":{"@id":"/blog/scaling-up-and-down-brokers-with-artemiscloud-operator/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"/blog/scaling-up-and-down-brokers-with-artemiscloud-operator/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["/blog/scaling-up-and-down-brokers-with-artemiscloud-operator/"]}]},{"@type":"BreadcrumbList","@id":"/blog/scaling-up-and-down-brokers-with-artemiscloud-operator/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"/","url":"/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@id":"/blogscaling-up-and-down-brokers-with-artemiscloud-operator/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"/#/schema/article/1","headline":"Scaling Up and Down Brokers with ArtemisCloud Operator","description":"How to use operator to scale up and down broker pods","isPartOf":{"@id":"/blog/scaling-up-and-down-brokers-with-artemiscloud-operator/"},"mainEntityOfPage":{"@id":"/blog/scaling-up-and-down-brokers-with-artemiscloud-operator/"},"datePublished":"2021-02-04T00:00:00CET","dateModified":"2021-02-18T00:00:00CET","author":{"@id":"/#/schema/person/2"},"publisher":{"@id":"/#/schema/organization/1"},"image":{"@id":"/blog/scaling-up-and-down-brokers-with-artemiscloud-operator/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"/#/schema/person/2","name":null,"sameAs":[]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"/blog/scaling-up-and-down-brokers-with-artemiscloud-operator/#/schema/image/2","url":"/artemiscloud.png","contentUrl":"/artemiscloud.png","caption":"Scaling Up and Down Brokers with ArtemisCloud Operator"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=/site.webmanifest></head><body class="blog single"><div class=header-bar></div><header class="navbar navbar-expand-md navbar-light doks-navbar"><nav class="container-fluid flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-auto" href=/ aria-label=ArtemisCloud.io>ArtemisCloud.io</a>
<button class="btn btn-menu d-block d-md-none order-5" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-md-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-md-none"></div><div class="offcanvas-header d-md-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/>ArtemisCloud.io</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body px-4"><h3 class="h6 text-uppercase mb-3 d-md-none">Main</h3><ul class="nav flex-column flex-md-row ms-md-n3"><li class=nav-item><a class="nav-link ps-0 py-1" href=/docs/getting-started/introduction/>Docs</a></li><li class=nav-item><a class="nav-link ps-0 py-1 active" href=/blog/>Blog</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/community/>Community</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/docs/getting-started/introduction/>Get Started</a></li></ul><hr class="text-black-50 my-4 d-md-none"><h3 class="h6 text-uppercase mb-3 d-md-none">Socials</h3><ul class="nav flex-column flex-md-row ms-md-auto me-md-n5 pe-md-2"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://github.com/artemiscloud><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-md-none">GitHub</small></a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=https://twitter.com/artemiscloudio><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg><small class="ms-2 d-md-none">Twitter</small></a></li></ul></div></div><button id=mode class="btn btn-link order-md-1" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></nav></header><div class="wrap container-fluid" role=document><div class=content><div class="row justify-content-center"><div class="col-md-12 col-lg-10 col-xl-8"><article><div class=blog-header><h1>Scaling Up and Down Brokers with ArtemisCloud Operator</h1><p><small>Posted February 4, 2021 by &nbsp;&dash;&nbsp;<strong>7&nbsp;min read</strong></small><p></div><p class=lead>Deploying the Basic Broker Image</p><p>With ArtemisCloud operator one can easily manage the broker clusters.
Either scaling up number of nodes(pods) when workload is high, or scaling down when some is not needed &ndash; without messages being lost or stuck.</p><h3 id=prerequisite>Prerequisite <a href=#prerequisite class=anchor aria-hidden=true>#</a></h3><p>Before you start you need have access to a running Kubernetes cluster environment. A <a href=https://minikube.sigs.k8s.io/docs/start/>Minikube</a> running on your laptop will just do fine. The ArtemisCloud operator also runs in a Openshift cluster environment like <a href=https://developers.redhat.com/products/codeready-containers/overview>CodeReady Container</a>. In this blog we assume you have Kubernetes cluster environment. (If you use CodeReady the client tool is <strong>oc</strong> in place of <strong>kubectl</strong>)</p><h3 id=step-1---deploy-artemiscloud-operator>Step 1 - Deploy ArtemisCloud Operator <a href=#step-1---deploy-artemiscloud-operator class=anchor aria-hidden=true>#</a></h3><p>In this article we are using the <a href=https://github.com/artemiscloud/activemq-artemis-operator>artemiscloud operator repo</a>. In case you haven&rsquo;t done so, clone it to your local disk:</p><pre><code class=language-shell>$ git clone https://github.com/artemiscloud/activemq-artemis-operator.git
$ cd activemq-artemis-operator
</code></pre><p>If you are not sure how to deploy the operator take a look at <a href=/blog/getting-started-with-the-artemiscloud-operator/>this blog</a>.</p><p>In this blog post we assume you deployed the operator to a namespace called <strong>myproject</strong>.</p><p>After deployment is done, check the operator is up and running. For example run the following command:</p><pre><code class=language-shell>$ kubectl get pod -n myproject
NAME                                         READY   STATUS    RESTARTS   AGE
activemq-artemis-operator-58bb658f4c-m9rfr   1/1     Running   0          2m46s
</code></pre><h3 id=step-2---deploy-activemq-artemis-broker>Step 2 - Deploy ActiveMQ Artemis broker <a href=#step-2---deploy-activemq-artemis-broker class=anchor aria-hidden=true>#</a></h3><p>In this step we&rsquo;ll setup a one-node broker in kubernetes. First we need create a broker custom resource file.</p><p>Use your favorite text editor to create a file called <strong>artemis-clustered.yaml</strong> under your repo root directory with the following content:</p><p><a name=broker_clustered_yaml></a></p><pre><code class=language-yaml>    apiVersion: broker.amq.io/v2alpha4
    kind: ActiveMQArtemis
    metadata:
      name: ex-aao
    spec:
      deploymentPlan:
        size: 1
        image: quay.io/artemiscloud/activemq-artemis-broker-kubernetes:0.2.1
        persistenceEnabled: true
        messageMigration: true
</code></pre><p>Save it and deploy it using the following command:</p><pre><code class=language-shell>$ kubectl create -f artemis-clustered.yaml -n myproject
activemqartemis.broker.amq.io/ex-aao created
</code></pre><p>The custom resource file tells the operator to deploy one broker pod from the image <strong>quay.io/artemiscloud/activemq-artemis-broker-kubernetes:0.2.1</strong>,
configured with <strong>persistenceEnabled: true</strong> and <strong>messageMigration: true</strong>.</p><p><strong>persistenceEnabled: true</strong> means the broker persists messages to persistent storage.</p><p><strong>messageMigration: true</strong> means if a broker pod is shut down, its messages will be migrated to another live broker pod so that those messages will be processed.</p><p>In a while the broker pod should be up and running:</p><pre><code class=language-shell>$ kubectl get pod -n myproject
NAME                                         READY   STATUS    RESTARTS   AGE
activemq-artemis-operator-58bb658f4c-m9rfr   1/1     Running   0          7m14s
ex-aao-ss-0                                  1/1     Running   0          83s
</code></pre><h3 id=step-3---scaling-up>Step 3 - Scaling up <a href=#step-3---scaling-up class=anchor aria-hidden=true>#</a></h3><p>To inform the operator that we want to scale from one to two broker pods modify artemis-clustered.yaml file to set the <strong>size</strong> to 2</p><pre><code class=language-yaml>    apiVersion: broker.amq.io/v2alpha4
    kind: ActiveMQArtemis
    metadata:
      name: ex-aao
    spec:
      deploymentPlan:
        size: 2
        image: quay.io/artemiscloud/activemq-artemis-broker-kubernetes:0.2.1
        persistenceEnabled: true
        messageMigration: true
</code></pre><p>and apply it:</p><pre><code class=language-shell>    $ kubectl apply -f artemis-clustered.yaml -n myproject
</code></pre><p>Verify that 2 pods are spawned up in a while:</p><pre><code class=language-shell>$ kubectl get pod -n myproject
NAME                                         READY   STATUS    RESTARTS   AGE
activemq-artemis-operator-58bb658f4c-m9rfr   1/1     Running   0          12m
ex-aao-ss-0                                  1/1     Running   0          6m33s
ex-aao-ss-1                                  1/1     Running   0          75s
</code></pre><h3 id=step-4---send-messages-to-both-brokers>Step 4 - Send messages to both brokers <a href=#step-4---send-messages-to-both-brokers class=anchor aria-hidden=true>#</a></h3><p>Run the following commands to send 100 messages to each broker:</p><p>broker0 at pod ex-aao-ss-0</p><pre><code class=language-shell>$ kubectl exec ex-aao-ss-0 -n myproject -- /bin/bash /home/jboss/amq-broker/bin/artemis producer --user admin --password admin --url tcp://ex-aao-ss-0:61616 --message-count 100
OpenJDK 64-Bit Server VM warning: If the number of processors is expected to increase from one, then you should configure the number of parallel GC threads appropriately using -XX:ParallelGCThreads=N
Connection brokerURL = tcp://ex-aao-ss-0:61616
Producer ActiveMQQueue[TEST], thread=0 Started to calculate elapsed time ...

Producer ActiveMQQueue[TEST], thread=0 Produced: 100 messages
Producer ActiveMQQueue[TEST], thread=0 Elapsed time in second : 0 s
Producer ActiveMQQueue[TEST], thread=0 Elapsed time in milli second : 466 milli seconds
</code></pre><p>broker1 at pod ex-aao-ss-1</p><pre><code class=language-shell>$ kubectl exec ex-aao-ss-1 -n myproject -- /bin/bash /home/jboss/amq-broker/bin/artemis producer --user admin --password admin --url tcp://ex-aao-ss-1:61616 --message-count 100
OpenJDK 64-Bit Server VM warning: If the number of processors is expected to increase from one, then you should configure the number of parallel GC threads appropriately using -XX:ParallelGCThreads=N
Connection brokerURL = tcp://ex-aao-ss-1:61616
Producer ActiveMQQueue[TEST], thread=0 Started to calculate elapsed time ...

Producer ActiveMQQueue[TEST], thread=0 Produced: 100 messages
Producer ActiveMQQueue[TEST], thread=0 Elapsed time in second : 0 s
Producer ActiveMQQueue[TEST], thread=0 Elapsed time in milli second : 511 milli seconds
</code></pre><p>The messages are send to a queue <strong>TEST</strong> in each broker. The following commands can show the queue&rsquo;s message count on each broker:</p><p>broker0 at pod ex-aao-ss-0</p><pre><code class=language-shell>$ kubectl exec ex-aao-ss-0 -n myproject -- /bin/bash /home/jboss/amq-broker/bin/artemis queue stat --user admin --password admin --url tcp://ex-aao-ss-0:61616
OpenJDK 64-Bit Server VM warning: If the number of processors is expected to increase from one, then you should configure the number of parallel GC threads appropriately using -XX:ParallelGCThreads=N
Connection brokerURL = tcp://ex-aao-ss-0:61616
|NAME                     |ADDRESS                  |CONSUMER_COUNT |MESSAGE_COUNT |MESSAGES_ADDED |DELIVERING_COUNT |MESSAGES_ACKED |SCHEDULED_COUNT |ROUTING_TYPE |
|$.artemis.internal.sf.my-cluster.f5e3b3bf-71b2-11eb-ab9a-0242ac110005|$.artemis.internal.sf.my-cluster.f5e3b3bf-71b2-11eb-ab9a-0242ac110005|1              |0             |0              |0                |0              |0               |MULTICAST    |
|DLQ                      |DLQ                      |0              |0             |0              |0                |0              |0               |ANYCAST      |
|ExpiryQueue              |ExpiryQueue              |0              |0             |0              |0                |0              |0               |ANYCAST      |
|TEST                     |TEST                     |0              |100           |100            |0                |0              |0               |ANYCAST      |
|activemq.management.8333dec3-8376-4b50-a9d0-f2197c55e6a8|activemq.management.8333dec3-8376-4b50-a9d0-f2197c55e6a8|1              |0             |0              |0                |0              |0               |MULTICAST    |
|notif.f9cf93f9-71b2-11eb-ab9a-0242ac110005.ActiveMQServerImpl_serverUUID=f5e3b3bf-71b2-11eb-ab9a-0242ac110005|activemq.notifications   |1              |0             |16             |0                |16             |0               |MULTICAST    |
</code></pre><p>broker1 at pod ex-aao-ss-1</p><pre><code class=language-shell>$ kubectl exec ex-aao-ss-1 -n myproject -- /bin/bash /home/jboss/amq-broker/bin/artemis queue stat --user admin --password admin --url tcp://ex-aao-ss-1:61616
OpenJDK 64-Bit Server VM warning: If the number of processors is expected to increase from one, then you should configure the number of parallel GC threads appropriately using -XX:ParallelGCThreads=N
Connection brokerURL = tcp://ex-aao-ss-1:61616
|NAME                     |ADDRESS                  |CONSUMER_COUNT |MESSAGE_COUNT |MESSAGES_ADDED |DELIVERING_COUNT |MESSAGES_ACKED |SCHEDULED_COUNT |ROUTING_TYPE |
|$.artemis.internal.sf.my-cluster.39079f07-71b2-11eb-88be-0242ac110004|$.artemis.internal.sf.my-cluster.39079f07-71b2-11eb-88be-0242ac110004|1              |0             |0              |0                |0              |0               |MULTICAST    |
|DLQ                      |DLQ                      |0              |0             |0              |0                |0              |0               |ANYCAST      |
|ExpiryQueue              |ExpiryQueue              |0              |0             |0              |0                |0              |0               |ANYCAST      |
|TEST                     |TEST                     |0              |100           |100            |0                |0              |0               |ANYCAST      |
|activemq.management.2a56ebf0-37ad-4cad-9b45-b84cb148f2ff|activemq.management.2a56ebf0-37ad-4cad-9b45-b84cb148f2ff|1              |0             |0              |0                |0              |0               |MULTICAST    |
|notif.fa438b23-71b2-11eb-88be-0242ac110004.ActiveMQServerImpl_serverUUID=39079f07-71b2-11eb-88be-0242ac110004|activemq.notifications   |1              |0             |12             |0                |12             |0               |MULTICAST    |
</code></pre><h3 id=step-5---scale-down-with-message-draining>Step 5 - Scale down with message draining <a href=#step-5---scale-down-with-message-draining class=anchor aria-hidden=true>#</a></h3><p>The operator not only can scale up brokers in a cluster but also can scale them down. Now we have messages on both brokers. If we scale one broker down, will the messsages go offline with it and stuck in its persistence store?</p><p>The answer is no. As we set <strong>messageMigration: true</strong> in the <a href=#broker_clustered_yaml>broker cr</a>, the operator will automatically &ldquo;migrate&rdquo; the messages on a scaled down broker pod to one of the live broker pod, a process called &ldquo;message draining&rdquo;.</p><p>Internally when the operator detects that a broker pod is down, it starts up a &ldquo;drainer&rdquo; broker pod who has access to the down pod&rsquo;s persistence store. It loads the messages in the store and sends those messages to a target live broker pod. When this is done the &ldquo;drainer&rdquo; pod shuts down itself.</p><p>Now scale down the cluster from 2 pods to one. Edit the <a href=#broker_clustered_yaml>broker cr</a> file and change the size back to 1:</p><pre><code class=language-yaml>    apiVersion: broker.amq.io/v2alpha4
    kind: ActiveMQArtemis
    metadata:
      name: ex-aao
    spec:
      deploymentPlan:
        size: 1
        image: quay.io/artemiscloud/activemq-artemis-broker-kubernetes:0.2.1
        persistenceEnabled: true
        messageMigration: true
</code></pre><p>Apply it:</p><pre><code class=language-shell>$ kubectl apply -f artemis-clustered.yaml -n myproject
activemqartemis.broker.amq.io/ex-aao configured
</code></pre><p>In a moment the broker pods will go down to 1. To check, run</p><pre><code class=language-shell>$ kubectl get pod -n myproject
NAME                                         READY   STATUS    RESTARTS   AGE
activemq-artemis-operator-58bb658f4c-m9rfr   1/1     Running   0          26m
ex-aao-ss-0                                  1/1     Running   0          20m
</code></pre><p>Now check the messages in queue TEST at the pod again:</p><pre><code class=language-shell>$ kubectl exec ex-aao-ss-0 -n myproject -- /bin/bash /home/jboss/amq-broker/bin/artemis queue stat --user admin --password admin --url tcp://ex-aao-ss-0:61616
OpenJDK 64-Bit Server VM warning: If the number of processors is expected to increase from one, then you should configure the number of parallel GC threads appropriately using -XX:ParallelGCThreads=N
Connection brokerURL = tcp://ex-aao-ss-0:61616
|NAME                     |ADDRESS                  |CONSUMER_COUNT |MESSAGE_COUNT |MESSAGES_ADDED |DELIVERING_COUNT |MESSAGES_ACKED |SCHEDULED_COUNT |ROUTING_TYPE |
|$.artemis.internal.sf.my-cluster.f5e3b3bf-71b2-11eb-ab9a-0242ac110005|$.artemis.internal.sf.my-cluster.f5e3b3bf-71b2-11eb-ab9a-0242ac110005|0              |0             |0              |0                |0              |0               |MULTICAST    |
|DLQ                      |DLQ                      |0              |0             |0              |0                |0              |0               |ANYCAST      |
|ExpiryQueue              |ExpiryQueue              |0              |0             |0              |0                |0              |0               |ANYCAST      |
|TEST                     |TEST                     |0              |200           |200            |0                |0              |0               |ANYCAST      |
|activemq.management.8ee46c3d-c2ba-4e1c-9b6c-f2631e662cb1|activemq.management.8ee46c3d-c2ba-4e1c-9b6c-f2631e662cb1|1              |0             |0              |0                |0              |0               |MULTICAST    |
</code></pre><p>It shows queue TEST&rsquo;s message count is <strong>200</strong> now!</p><h3 id=more-information>More information <a href=#more-information class=anchor aria-hidden=true>#</a></h3><ul><li>Check out <a href=https://github.com/artemiscloud>artemiscloud project repo</a></li><li>Reach the <a href=artemiscloudio.slack.com>dev team at slack</a> for questions/issues/help</li></ul></article></div></div></div></div><footer class="footer text-muted"><div class=container-fluid><div class=row><div class=col><a href=https://www.redhat.com/><img height=32px src=/images/Logo-Red_Hat-Sponsored_By-A-Standard-RGB.png alt="Red Hat"></a></div><div class=col-10><p style=font-size:12px>Apache, Apache ActiveMQ Artemis,Artemis and associated open source project names are trademarks of the <a href=https://www.apache.org/>Apache Software Foundation</a>.</p></div></div></div></footer><script src=/js/bootstrap.min.0a0106334435d4110713bfaff4acaf02533b0c56d44412a74e9518db07672ddb7e099a9c7517bc9cb529e2ddd4ae2e438b40b720288900d5e74fb6d8928d9097.js integrity="sha512-CgEGM0Q11BEHE7+v9KyvAlM7DFbURBKnTpUY2wdnLdt+CZqcdRe8nLUp4t3Uri5Di0C3ICiJANXnT7bYko2Qlw==" crossorigin=anonymous defer></script>
<script src=/js/highlight.min.0d31f7af12feb83ee633b6351b023ee643ea3412376fbaa09c5a26d1a5ef999939f1ad379a5b12e1199a2c7d72ae1b23f633060a679628dcbfb0e72378cd20be.js integrity="sha512-DTH3rxL+uD7mM7Y1GwI+5kPqNBI3b7qgnFom0aXvmZk58a03mlsS4RmaLH1yrhsj9jMGCmeWKNy/sOcjeM0gvg==" crossorigin=anonymous defer></script>
<script src=/main.min.6afc4bf655f45ae3e63629ec95be8bd2e0e792084b5635a6fe70b169fa9d1491638b3a4e900ed59c2e017ca18768e5c392e110d0e1336509f49f7dc418d16eef.js integrity="sha512-avxL9lX0WuPmNinslb6L0uDnkghLVjWm/nCxafqdFJFjizpOkA7VnC4BfKGHaOXDkuEQ0OEzZQn0n33EGNFu7w==" crossorigin=anonymous defer></script></body></html>