<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=/themify-icons/themify-icons.css><link rel=stylesheet href=/main.8a6ad721d6f762118202f0606b968521c1ea6d8fd80415e520fed9dd178be0638b5c6a4801ea1375452c21684313af1a953cdcc965f1abc60203032b7a41f853.css integrity="sha512-imrXIdb3YhGCAvBga5aFIcHqbY/YBBXlIP7Z3ReL4GOLXGpIAeoTdUUsIWhDE68alTzcyWXxq8YCAwMrekH4Uw==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Using the custom init image - ArtemisCloud.io</title><meta name=description content="Introduction to the operator custom init image"><link rel=canonical href=/blog/using-the-custom-init-image/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Using the custom init image"><meta property="og:description" content="Introduction to the operator custom init image"><meta property="og:url" content="/blog/using-the-custom-init-image/"><meta property="og:site_name" content="ArtemisCloud.io"><meta property="article:published_time" content="2021-02-02T00:00:00+00:00"><meta property="article:modified_time" content="2021-02-05T00:00:00+00:00"><meta property="og:image" content="/artemiscloud.png"><meta property="og:image:alt" content="ArtemisCloud.io"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@artemiscloudio"><meta name=twitter:creator content="@henkverlinde"><meta name=twitter:title content="Using the custom init image"><meta name=twitter:description content="Introduction to the operator custom init image"><meta name=twitter:image content="/artemiscloud.png"><meta name=twitter:image:alt content="Using the custom init image"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"/#/schema/organization/1","name":"ArtemisCloud.io","url":"/","sameAs":["https://twitter.com/artemiscloudio","https://github.com/artemiscloud"],"logo":{"@type":"ImageObject","@id":"/#/schema/image/1","url":"/artemiscloud.png","width":512,"height":512,"caption":"ArtemisCloud.io"},"image":{"@id":"/#/schema/image/1"}},{"@type":"WebSite","@id":"/#/schema/website/1","url":"/","name":"ArtemisCloud.io","description":"ArtemisCloud.io is a collection of container images that provide a way to deploy the Apache ActiveMQ Artemis Broker on Kubernetes.","publisher":{"@id":"/#/schema/organization/1"}},{"@type":"WebPage","@id":"/blog/using-the-custom-init-image/","url":"/blog/using-the-custom-init-image/","name":"Using the custom init image","description":"Introduction to the operator custom init image","isPartOf":{"@id":"/#/schema/website/1"},"about":{"@id":"/#/schema/organization/1"},"datePublished":"2021-02-02T00:00:00CET","dateModified":"2021-02-05T00:00:00CET","breadcrumb":{"@id":"/blog/using-the-custom-init-image/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"/blog/using-the-custom-init-image/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["/blog/using-the-custom-init-image/"]}]},{"@type":"BreadcrumbList","@id":"/blog/using-the-custom-init-image/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"/","url":"/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@id":"/blogusing-the-custom-init-image/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"/#/schema/article/1","headline":"Using the custom init image","description":"Introduction to the operator custom init image","isPartOf":{"@id":"/blog/using-the-custom-init-image/"},"mainEntityOfPage":{"@id":"/blog/using-the-custom-init-image/"},"datePublished":"2021-02-02T00:00:00CET","dateModified":"2021-02-05T00:00:00CET","author":{"@id":"/#/schema/person/2"},"publisher":{"@id":"/#/schema/organization/1"},"image":{"@id":"/blog/using-the-custom-init-image/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"/#/schema/person/2","name":null,"sameAs":[]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"/blog/using-the-custom-init-image/#/schema/image/2","url":"/artemiscloud.png","contentUrl":"/artemiscloud.png","caption":"Using the custom init image"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=/site.webmanifest></head><body class="blog single"><div class=header-bar></div><header class="navbar navbar-expand-md navbar-light doks-navbar"><nav class="container-fluid flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-auto" href=/ aria-label=ArtemisCloud.io>ArtemisCloud.io</a>
<button class="btn btn-menu d-block d-md-none order-5" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-md-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-md-none"></div><div class="offcanvas-header d-md-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/>ArtemisCloud.io</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body px-4"><h3 class="h6 text-uppercase mb-3 d-md-none">Main</h3><ul class="nav flex-column flex-md-row ms-md-n3"><li class=nav-item><a class="nav-link ps-0 py-1" href=/docs/getting-started/introduction/>Docs</a></li><li class=nav-item><a class="nav-link ps-0 py-1 active" href=/blog/>Blog</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/community/>Community</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/docs/getting-started/introduction/>Get Started</a></li></ul><hr class="text-black-50 my-4 d-md-none"><h3 class="h6 text-uppercase mb-3 d-md-none">Socials</h3><ul class="nav flex-column flex-md-row ms-md-auto me-md-n5 pe-md-2"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://github.com/artemiscloud><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-md-none">GitHub</small></a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=https://twitter.com/artemiscloudio><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg><small class="ms-2 d-md-none">Twitter</small></a></li></ul></div></div><button id=mode class="btn btn-link order-md-1" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></nav></header><div class="wrap container-fluid" role=document><div class=content><div class="row justify-content-center"><div class="col-md-12 col-lg-10 col-xl-8"><article><div class=blog-header><h1>Using the custom init image</h1><p><small>Posted February 2, 2021 by &nbsp;&dash;&nbsp;<strong>4&nbsp;min read</strong></small><p></div><p class=lead>Deploying the Basic Broker Image</p><p>Starting from <a href=https://github.com/artemiscloud/activemq-artemis-operator/tree/v0.18.1>v0.18.1</a>, the ArtemisCloud Operator
enables you to specify a <strong>custom Init Container image</strong>. Specifying a custom Init Container image allows you to provide your own broker configuration within the Operator framework.</p><h3 id=what-is-a-custom-init-container-image>What is a custom Init Container image? <a href=#what-is-a-custom-init-container-image class=anchor aria-hidden=true>#</a></h3><p>The ArtemisCloud Operator uses a <a href=https://github.com/artemiscloud/activemq-artemis-operator/blob/v0.18.1/deploy/crds/broker_activemqartemis_crd.yaml>Custom Resource Definition (CRD)</a> to define the broker configuration. In Kubernetes, a CRD is a schema of configuration items or parameters. By creating a corresponding Custom Resource (CR) instance, you can specify values for configuration items in the CRD. For example, you can define address settings
in this <a href=https://github.com/artemiscloud/activemq-artemis-operator/blob/v0.18.1/deploy/examples/artemis-basic-address-settings-deployment.yaml>sample CR file</a>.</p><p>For configuration that <em>isn&rsquo;t</em> exposed in the CRD, you can specify a custom Init Container image to manipulate or add to the configuration that has been created by the Operator. When the CR is deployed and the broker instance is created, the Operator will then run a user-provided post-configuration script.</p><h3 id=how-it-works>How it works <a href=#how-it-works class=anchor aria-hidden=true>#</a></h3><p>Internally, the ArtemisCloud Operator uses a specialized container called an <em>Init Container</em> to configure each broker instance. If no custom image for the Init Container has been specified, the Operator uses a <a href=https://quay.io/repository/artemiscloud/activemq-artemis-broker-init>built-in Init Container image</a>, which
is responsible for the configuration. The broker configuration generated by the Init Container is passed to the <a href=https://quay.io/repository/artemiscloud/activemq-artemis-broker-kubernetes>broker container image</a> to use when launching the broker.</p><p>If a custom Init Container image <em>is</em> provided and specified in the Custom Resource (CR), then this is used to create the configuration. Since the custom image is built on top of the ArtemisCloud built-in Init Container image, the custom image first generates the broker configuration that is defined in the CR. Then, the Operator executes the post-configuration (<code>post-config.sh</code>) script provided by the custom Init Container.</p><p>For ease of use, the environment variable <code>CONFIG_INSTANCE_DIR</code> is set. This environment variable points to the broker instance directory, which has the following structure:</p><p><a name=instancedir></a></p><pre><code>${CONFIG_INSTANCE_DIR}
  |
  \--/bin
  \--/etc
  \--/data
  \--/lib
  \--/log
  \--/tmp
</code></pre><p>When the <code>post-config.sh</code> script is invoked, the directory specified in <code>CONFIG_INSTANCE_DIR</code> already contains all of the configuration
files generated by the built-in image (via the configuration specified in the CR) and is available for the <code>post-config.sh</code> script to do extra configuration.</p><p>For example, a custom Init Container might be used to modify the logging settings and add or override some specific configurations in <code>${CONFIG_INSTANCE_DIR}/etc</code>. In addition, the custom Init Container might put extra runtime dependencies (<code>.jar</code> files) in the <code>${CONFIG_INSTANCE_DIR}/lib</code> directory so that the broker can
use them.</p><p>After the <code>post-config.sh</code> script is executed, the broker instance is launched with the updated configuration.</p><h3 id=specifying-a-custom-init-container-image>Specifying a custom Init Container image <a href=#specifying-a-custom-init-container-image class=anchor aria-hidden=true>#</a></h3><ol><li><p>First, you need to implement your custom Init Container image.</p><p>The custom image should follow these predefined rules:</p><ul><li>The custom image must use the ArtemisCloud Operator&rsquo;s <a href=https://quay.io/repository/artemiscloud/activemq-artemis-broker-init>built-in Init Container image</a> as the base image in its Docker file. For example:</li></ul><pre><code>FROM quay.io/artemiscloud/activemq-artemis-broker-init:0.2.3
...
</code></pre><ul><li>The custom image must include a <code>post-config.sh</code> script in the <code>/amq/scripts</code> directory. The absolute path will be <code>/amq/scripts/post-config.sh</code>.</li></ul><p>The <code>post-config.sh</code> script is where you modify the configuration of the broker or add any third party dependencies.</p><p>If you need additional resources (<code>.xml</code> files, <code>.jar</code> files, etc.) for your custom configuration, you need to add them to your image and make sure that they are accessible to your post-config scripts.</p></li><li><p>Next, you need to build your custom Init Container image and put it in a container repository (for example you can create a repository on <a href=quay.io>Red Hat Quay</a>).</p></li><li><p>When you have added the image to a repository, you need to configure the Operator to use the custom Init Container image. To do this, edit the CR file. For the <code>image</code> property, specify the custom image. For example:</p><pre><code class=language-yaml>apiVersion: broker.amq.io/v2alpha4
kind: ActiveMQArtemis
metadata:
    name: ex-aao
    spec:
        deploymentPlan:
            size: 1
            image: quay.io/artemiscloud/activemq-artemis-broker-kubernetes:0.2.1
            initImage: &lt;your_custom_init_image_url&gt;
            ...
</code></pre></li><li><p>Finally, deploy the CR file in the usual manner. For more information, see <a href=/blog/getting-started-with-the-artemiscloud-operator/ title="About Us">Getting Started with the ArtemisCloud Operator</a>.</p></li></ol><h3 id=further-information>Further information <a href=#further-information class=anchor aria-hidden=true>#</a></h3><ul><li><p>A fully working example is available <a href=https://github.com/artemiscloud/artemiscloud-examples/tree/main/operator/init/jdbc>here</a>.</p></li><li><p>For issues or suggestions please open an issue at <a href=https://github.com/artemiscloud/activemq-artemis-operator/issues>ArtemisCloud</a>.</p></li></ul></article></div></div></div></div><footer class="footer text-muted"><div class=container-fluid><div class=row><div class=col><a href=https://www.redhat.com/><img height=32px src=/images/Logo-Red_Hat-Sponsored_By-A-Standard-RGB.png alt="Red Hat"></a></div><div class=col-10><p style=font-size:12px>Apache, Apache ActiveMQ Artemis,Artemis and associated open source project names are trademarks of the <a href=https://www.apache.org/>Apache Software Foundation</a>.</p></div></div></div></footer><script src=/js/bootstrap.min.0a0106334435d4110713bfaff4acaf02533b0c56d44412a74e9518db07672ddb7e099a9c7517bc9cb529e2ddd4ae2e438b40b720288900d5e74fb6d8928d9097.js integrity="sha512-CgEGM0Q11BEHE7+v9KyvAlM7DFbURBKnTpUY2wdnLdt+CZqcdRe8nLUp4t3Uri5Di0C3ICiJANXnT7bYko2Qlw==" crossorigin=anonymous defer></script>
<script src=/js/highlight.min.0d31f7af12feb83ee633b6351b023ee643ea3412376fbaa09c5a26d1a5ef999939f1ad379a5b12e1199a2c7d72ae1b23f633060a679628dcbfb0e72378cd20be.js integrity="sha512-DTH3rxL+uD7mM7Y1GwI+5kPqNBI3b7qgnFom0aXvmZk58a03mlsS4RmaLH1yrhsj9jMGCmeWKNy/sOcjeM0gvg==" crossorigin=anonymous defer></script>
<script src=/main.min.6afc4bf655f45ae3e63629ec95be8bd2e0e792084b5635a6fe70b169fa9d1491638b3a4e900ed59c2e017ca18768e5c392e110d0e1336509f49f7dc418d16eef.js integrity="sha512-avxL9lX0WuPmNinslb6L0uDnkghLVjWm/nCxafqdFJFjizpOkA7VnC4BfKGHaOXDkuEQ0OEzZQn0n33EGNFu7w==" crossorigin=anonymous defer></script></body></html>