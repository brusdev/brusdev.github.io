<!doctype html><html lang=en-us><head><meta charset=utf-8><title></title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><meta name=description content="ArtemisCloud.io is a collection of container images that provide a way to deploy the Apache ActiveMQ Artemis Broker on Kubernetes."><meta name=author content="Themefisher"><meta name=generator content="Hugo 0.100.2"><link rel=stylesheet href=/plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=/plugins/themify-icons/themify-icons.css><link rel=stylesheet href=/plugins/slick/slick.css><link href=/scss/style.min.css rel=stylesheet media=screen><link rel="shortcut icon" href=/favicon.png type=image/x-icon><link rel=icon href=/favicon.png type=image/x-icon><meta property="og:image" content="https://artemiscloud.io/favicon.png"><meta property="og:title" content><meta property="og:description" content="Overview of the ArtemisCloud Operator Custom Resource Definitions In general, a Custom Resource Definition (CRD) is a schema of configuration items that you can modify for a custom Kubernetes object deployed with an Operator."><meta property="og:type" content="article"><meta property="og:url" content="/documentation/operator/"><meta property="article:section" content="documentation"></head><body><header class=navigation><div class=container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><a class=navbar-brand href=/></a><button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav mx-auto"><li class=nav-item><a class=nav-link href=/>Home</a></li><li class=nav-item><a class=nav-link href=/blog>Blog</a></li><li class=nav-item><a class=nav-link href=/documentation/introduction>Documentation</a></li><li class=nav-item><a class=nav-link href=/releases>Releases</a></li><li class=nav-item><a class=nav-link href=/community>Community</a></li></ul></div></nav></div></header><section class="section pb-0"><div class="container text-center"><h1 class=display-3></h1></div></section><div class=body style=display:flex><div class=nav-container data-component=artemiscloud-docs data-version=dev><aside class=nav style=font-size:smaller;width:300px><ul><li class=nav-item data-depth=0><span class=nav-text><a href=/documentation/introduction>Introduction<a></span></li><li class=nav-item data-depth=0><span class=nav-text><a href=/documentation/operator>The Broker Operator<a></span></li><nav id=TableOfContents><ul><li><a href=#overview-of-the-artemiscloud-operator-custom-resource-definitions>Overview of the ArtemisCloud Operator Custom Resource Definitions</a><ul><li><a href=#additional-resources>Additional resources</a></li><li><a href=#operator-deployment-notes>Operator deployment notes</a></li></ul></li><li><a href=#installing-the-operator-using-the-cli>Installing the Operator using the CLI</a><ul><li><a href=#getting-the-operator-code>Getting the Operator code</a></li><li><a href=#preparing-the-kubernetes-environment>Preparing the kubernetes Environment</a></li><li><a href=#deploy-the-operator>Deploy The Operator</a></li></ul></li><li><a href=#creating-operator-based-broker-deployments>Creating Operator-based broker deployments</a><ul><li><a href=#deploying-a-basic-broker-instance>Deploying a basic broker instance</a></li><li><a href=#deploying-clustered-brokers>Deploying clustered brokers</a></li><li><a href=#applying-custom-resource-changes-to-running-broker-deployments>Applying Custom Resource changes to running broker deployments</a></li></ul></li><li><a href=#configuring-scheduling-preemption-and-eviction>Configuring Scheduling, Preemption and Eviction</a><ul><li><a href=#liveness-and-readiness-probes>Liveness and Readiness Probes</a></li><li><a href=#tolerations>Tolerations</a></li><li><a href=#affinity>Affinity</a></li><li><a href=#labels-and-node-selectors>Labels and Node Selectors</a></li></ul></li></ul></nav><li class=nav-item data-depth=0><span class=nav-text><a href=/documentation/images>The Container Images<a></span></li><li class=nav-item data-depth=0><span class=nav-text><a href=/documentation/reference>Reference<a></span></li></ul></aside></div><main><div class=content style=display:flex;padding-right:20%;padding-left:10%;height:700px;overflow-y:scroll><article class=doc><div class=sect1><h2 id=overview-of-the-artemiscloud-operator-custom-resource-definitions>Overview of the ArtemisCloud Operator Custom Resource Definitions</h2><p>In general, a Custom Resource Definition (CRD) is a schema of configuration items that you can modify for a custom Kubernetes
object deployed with an Operator. By creating a corresponding Custom Resource (CR) instance, you can specify values for
configuration items in the CRD. If you are an Operator developer, what you expose through a CRD essentially becomes the
API for how a deployed object is configured and used. You can directly access the CRD through regular HTTP curl commands,
because the CRD gets exposed automatically through Kubernetes.</p><p>The following CRD&rsquo;s are available for the Operator and can be found in the Operator Repository under <em>config/crd/bases/</em></p><table><thead><tr><th style=text-align:left>CRD</th><th style=text-align:center>Description</th></tr></thead><tbody><tr><td style=text-align:left><strong>Main broker CRD</strong></td><td style=text-align:center>Create and configure a broker deployment</td></tr><tr><td style=text-align:left><strong>Address CRD</strong></td><td style=text-align:center>Create addresses and queues for a broker deployment</td></tr><tr><td style=text-align:left><strong>Scaledown CRD</strong></td><td style=text-align:center>Creates a Scaledown Controller for message migration</td></tr><tr><td style=text-align:left><strong>Security CRD</strong></td><td style=text-align:center>Configure the security and authentication method of the Broker</td></tr></tbody></table><h3 id=additional-resources>Additional resources</h3><p>To learn how to install the ActiveMQ Artemis Operator (and all included CRDs) using:</p><p>The Kubernetes CLI, see <a href=#installing-the-operator-using-the-cli>Installing the Operator</a></p><p>For complete configuration references to use when creating CR instances based on the main broker and address CRDs, see:</p><p>Broker Custom Resource configuration reference</p><p>Address Custom Resource configuration reference</p><p>Sample Custom Reference can be found in the Operator Repository under the <em>deploy/crs</em> directory</p><h3 id=operator-deployment-notes>Operator deployment notes</h3><p>This section describes some important considerations when planning an Operator-based deployment</p><p>Deploying the Custom Resource Definitions (CRDs) that accompany the ActiveMQ Artemis Operator requires cluster administrator
privileges for your Kubernetes cluster. When the Operator is deployed, non-administrator users can create broker instances
via corresponding Custom Resources (CRs). To enable regular users to deploy CRs, the cluster administrator must first assign
roles and permissions to the CRDs. For more information, see Creating cluster roles for Custom Resource Definitions in the
Kubernetes documentation.</p><p>When you update your cluster with the CRDs for the latest Operator version, this update affects all projects in the cluster.
Any broker Pods deployed from previous versions of the Operator might become unable to update their status. To fix this issue
for an affected project, you must also upgrade that project to use the latest version of the Operator.</p><p>You cannot create more than one broker deployment in a given Kubernetes project by deploying multiple broker Custom Resource (CR)
instances. However, when you have created a broker deployment in a project, you can deploy multiple CR instances for addresses.</p><p>If you intend to deploy brokers with persistent storage and do not have container-native storage in your Kubernetes cluster,
you need to manually provision Persistent Volumes (PVs) and ensure that these are available to be claimed by the Operator.
For example, if you want to create a cluster of two brokers with persistent storage (that is, by setting persistenceEnabled=true
in your CR), you need to have two persistent volumes available. By default, each broker instance requires storage of 2 GiB.</p><p>If you specify persistenceEnabled=false in your CR, the deployed brokers uses ephemeral storage. Ephemeral storage means
that every time you restart the broker Pods, any existing data is lost.</p><p>For more information about provisioning persistent storage in Kubernetes, see <a href=https://docs.openshift.com/container-platform/4.1/storage/understanding-persistent-storage.html target=_blank>Understanding persistent storage</a></p><h2 id=installing-the-operator-using-the-cli>Installing the Operator using the CLI</h2><p>This section shows how to use the Kubernetes command-line interface (CLI) to deploy the latest version of
the Operator for ArtemisCloud in your Kubernetes project.</p><p>If you intend to deploy brokers with persistent storage and do not have container-native storage in your Kubernetes cluster,
you need to manually provision Persistent Volumes (PVs) and ensure that they are available to be claimed by the Operator.
For example, if you want to create a cluster of two brokers with persistent storage (that is, by setting persistenceEnabled=true
in your Custom Resource), you need to have two PVs available. By default, each broker instance requires storage of 2 GiB.</p><p>If you specify persistenceEnabled=false in your Custom Resource, the deployed brokers uses ephemeral storage. Ephemeral
storage means that that every time you restart the broker Pods, any existing data is lost.</p><h3 id=getting-the-operator-code>Getting the Operator code</h3><p>This procedure shows how to access and prepare the code you need to install the latest version of the Operator for ArtemisCloud .</p><p>Download the latest version of the Operator from <a href=https://github.com/artemiscloud/activemq-artemis-operator/tags target=_blank>https://github.com/artemiscloud/activemq-artemis-operator/tags</a></p><p>When the download has completed, move the archive to your chosen installation directory.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ mkdir ~/broker/operator
</span></span><span style=display:flex><span>$ mv activemq-artemis-operator-0.18.1.zip ~/broker/operator
</span></span></code></pre></div><p>In your chosen installation directory, extract the contents of the archive. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cd ~/broker/operator
</span></span><span style=display:flex><span>$ unzip activemq-artemis-operator-0.18.1.zip
</span></span></code></pre></div><h3 id=preparing-the-kubernetes-environment>Preparing the kubernetes Environment</h3><p>Switch to the directory that was created when you extracted the archive. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cd activemq-artemis-operator
</span></span></code></pre></div><p>Specify the project in which you want to install the Operator. You can create a new project or switch to an existing one.</p><p>Create a new namespace:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl create namespace  &lt;project-name&gt;
</span></span></code></pre></div><p>Or, switch to an existing namespace:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl config set-context <span style=color:#66d9ef>$(</span>kubectl config current-context<span style=color:#66d9ef>)</span> --namespace<span style=color:#f92672>=</span> &lt;project-name&gt;
</span></span></code></pre></div><p>Specify a service account to use with the Operator.</p><p>In the deploy directory of the Operator archive that you extracted, open the service_account.yaml file.</p><p>Ensure that the kind element is set to ServiceAccount.</p><p>In the metadata section, assign a custom name to the service account, or use the default name. The default name is activemq-artemis-operator.</p><p>Create the service account in your project.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl create -f deploy/service_account.yaml
</span></span></code></pre></div><p>Specify a role name for the Operator.</p><p>Open the role.yaml file. This file specifies the resources that the Operator can use and modify.</p><p>Ensure that the kind element is set to Role.</p><p>In the metadata section, assign a custom name to the role, or use the default name. The default name is activemq-artemis-operator.</p><p>Create the role in your project.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl create -f deploy/role.yaml
</span></span></code></pre></div><p>Specify a role binding for the Operator. The role binding binds the previously-created service account to the Operator role,
based on the names you specified.</p><p>Open the role_binding.yaml file. Ensure that the name values for ServiceAccount and Role match those specified in the
service_account.yaml and role.yaml files. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>activemq-artemis-operator</span>
</span></span><span style=display:flex><span><span style=color:#f92672>subjects</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceAccount</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>activemq-artemis-operator</span>
</span></span><span style=display:flex><span><span style=color:#f92672>roleRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Role</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>activemq-artemis-operator</span>
</span></span></code></pre></div><p>Create the role binding in your project.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl create -f deploy/role_binding.yaml
</span></span></code></pre></div><p>In the procedure that follows, you deploy the Operator in your project.</p><h3 id=deploy-the-operator>Deploy The Operator</h3><p>Switch to the directory that was created when you previously extracted the Operator installation archive. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cd ~/broker/operator/amq-broker-operator--ocp-install-examples
</span></span></code></pre></div><p>Deploy the CRDs that are included with the Operator. You must install the CRDs in your Kubernetes cluster before deploying and starting the Operator.</p><p>Deploy the main broker CRD.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl create -f deploy/crds/broker_activemqartemis_crd.yaml
</span></span></code></pre></div><p>Deploy the address CRD.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl create -f deploy/crds/broker_activemqartemisaddress_crd.yaml
</span></span></code></pre></div><p>Deploy the scaledown controller CRD.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl create -f deploy/crds/broker_activemqartemisscaledown_crd.yaml
</span></span></code></pre></div><p>In the deploy directory of the Operator archive that you downloaded and extracted, open the operator.yaml file. Ensure that the value of the spec.containers.image property is set to the latest Operator image for ActiveMQ Artemis , as shown below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>image</span>: <span style=color:#ae81ff>quay.io/artemiscloud/activemq-artemis-operator:latest</span>
</span></span></code></pre></div><p>Deploy the Operator.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl create -f deploy/operator.yaml
</span></span></code></pre></div><p>In your Kubernetes project, the Operator starts in a new Pod.</p><p>In the Kubernetes web console, the information on the Events tab of the Operator Pod confirms that Kubernetes has deployed
the Operator image that you specified, has assigned a new container to a node in your Kubernetes cluster, and has started
the new container.</p><p>In addition, if you click the Logs tab within the Pod, the output should include lines resembling the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;info&#34;</span>,<span style=color:#e6db74>&#34;ts&#34;</span>:1553619035.8302743,<span style=color:#e6db74>&#34;logger&#34;</span>:<span style=color:#e6db74>&#34;kubebuilder.controller&#34;</span>,<span style=color:#e6db74>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Starting Controller&#34;</span>,<span style=color:#e6db74>&#34;controller&#34;</span>:<span style=color:#e6db74>&#34;activemqartemisaddress-controller&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;info&#34;</span>,<span style=color:#e6db74>&#34;ts&#34;</span>:1553619035.830541,<span style=color:#e6db74>&#34;logger&#34;</span>:<span style=color:#e6db74>&#34;kubebuilder.controller&#34;</span>,<span style=color:#e6db74>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Starting Controller&#34;</span>,<span style=color:#e6db74>&#34;controller&#34;</span>:<span style=color:#e6db74>&#34;activemqartemis-controller&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;info&#34;</span>,<span style=color:#e6db74>&#34;ts&#34;</span>:1553619035.9306898,<span style=color:#e6db74>&#34;logger&#34;</span>:<span style=color:#e6db74>&#34;kubebuilder.controller&#34;</span>,<span style=color:#e6db74>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Starting workers&#34;</span>,<span style=color:#e6db74>&#34;controller&#34;</span>:<span style=color:#e6db74>&#34;activemqartemisaddress-controller&#34;</span>,<span style=color:#e6db74>&#34;worker count&#34;</span>:1<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;level&#34;</span>:<span style=color:#e6db74>&#34;info&#34;</span>,<span style=color:#e6db74>&#34;ts&#34;</span>:1553619035.9311671,<span style=color:#e6db74>&#34;logger&#34;</span>:<span style=color:#e6db74>&#34;kubebuilder.controller&#34;</span>,<span style=color:#e6db74>&#34;msg&#34;</span>:<span style=color:#e6db74>&#34;Starting workers&#34;</span>,<span style=color:#e6db74>&#34;controller&#34;</span>:<span style=color:#e6db74>&#34;activemqartemis-controller&#34;</span>,<span style=color:#e6db74>&#34;worker count&#34;</span>:1<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>The preceding output confirms that the newly-deployed Operator is communicating with Kubernetes, that the controllers for
the broker and addressing are running, and that these controllers have started some workers.</p><p>It is recommended that you deploy only a single instance of the ActiveMQ Artemis Operator in a given Kubernetes project.
Setting the replicas element of your Operator deployment to a value greater than 1, or deploying the Operator more than
once in the same project is not recommended.</p><h2 id=creating-operator-based-broker-deployments>Creating Operator-based broker deployments</h2><h3 id=deploying-a-basic-broker-instance>Deploying a basic broker instance</h3><p>The following procedure shows how to use a Custom Resource (CR) instance to create a basic broker deployment.</p><pre><code>NOTE: You cannot create more than one broker deployment in a given Kubernetes project by deploying multiple Custom 
Resource (CR) instances. However, when you have created a broker deployment in a project, you can deploy multiple CR 
instances for addresses.
</code></pre><p>Prerequisites</p><ol><li><p>You must have already installed the ArtemisCloud Operator.</p></li><li><p>To use the Kubernetes command-line interface (CLI) to install the ActiveMQ Artemis Operator, see <a href=#installing-the-operator-using-the-cli>Installing the Operator</a>.</p></li></ol><p>When you have successfully installed the Operator, the Operator is running and listening for changes related to your CRs.
This example procedure shows how to use a CR instance to deploy a basic broker in your project.</p><ol><li>Start configuring a Custom Resource (CR) instance for the broker deployment.</li></ol><p>Using the Kubernetes command-line interface switch to the namespace you are using for your project</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl config set-context <span style=color:#66d9ef>$(</span>kubectl config current-context<span style=color:#66d9ef>)</span> --namespace<span style=color:#f92672>=</span> &lt;project-name&gt;
</span></span></code></pre></div><p>Open the sample CR file called broker_activemqartemis_cr.yaml that is included in the deploy/crs directory of the Operator
installation archive that you downloaded and extracted. For a basic broker deployment, the configuration might resemble
that shown below. This configuration is the default content of the broker_activemqartemis_cr.yaml sample CR.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>broker.amq.io/v2alpha4</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ActiveMQArtemis</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ex-aao</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>application</span>: <span style=color:#ae81ff>ex-aao-app</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#ae81ff>7.7.0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>deploymentPlan</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>size</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#f92672>quay.io/artemiscloud/activemq-artemis-broker-kubernetes</span>:
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>...</span>
</span></span></code></pre></div><p>Observe that the sample CR uses a naming convention of <strong>ex-aao</strong>. This naming convention denotes that the CR is an example
resource for the ArtemisCloud (based on the ActiveMQ Artemis project) Operator. When you deploy this sample CR, the resulting
Stateful Set uses the name <strong>ex-aao-ss</strong>. Furthermore, broker Pods in the deployment are directly based on the Stateful Set name,
for example, <strong>ex-aao-ss-0</strong>, <strong>ex-aao-ss-1</strong>, and so on. The application name in the CR appears in the deployment as a label on the Stateful Set.
You might use this label in a Pod selector, for example.</p><p>The size value specifies the number of brokers to deploy. The default value of 2 specifies a clustered broker deployment
of two brokers. However, to deploy a single broker instance, change the value to 1.</p><p>The image value specifies the container image to use to launch the broker. Ensure that this value specifies the latest
version of the ActiveMQ Artemis broker container image in the Quay.io repository, as shown below.</p><pre><code>image: quay.io/artemiscloud/activemq-artemis-broker-kubernetes:0.2.1
</code></pre><p>In the preceding step, the image attribute specifies a floating image tag (that is, ) rather than a full image tag (for example, -5).
When you specify this floating tag, your deployment uses the latest image available in the image stream. In addition,
when you specify a floating tag such as this, if the imagePullPolicy attribute in your Stateful Set is set to Always,
your deployment automatically pulls and uses new micro image versions (for example, -6, -7, and so on) when they become
available from quay.io. Deploy the CR instance.</p><p>Save the CR file.</p><p>Switch to the namespace in which you are creating the broker deployment.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl config set-context <span style=color:#66d9ef>$(</span>kubectl config current-context<span style=color:#66d9ef>)</span> --namespace<span style=color:#f92672>=</span> &lt;project-name&gt;
</span></span></code></pre></div><p>Create the CR.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl create -f &lt;path/to/custom-resource-instance&gt;.yaml
</span></span></code></pre></div><p>In the Kubernetes web console you will see a new Stateful Set called <strong>ex-aao-ss</strong>.</p><p>Click the <strong>ex-aao-ss</strong> Stateful Set. You see that there is one Pod, corresponding to the single broker that you defined in the CR.</p><p>Within the Stateful Set, click the pod link and you should see the status of the pod as running. Click on the logs link
in the top right corner to see the broker’s output.</p><p>To test that the broker is running normally, access a shell on the broker Pod to send some test messages.</p><p>Using the Kubernetes web console:</p><p>Click Pods on the left menu</p><p>Click the ex-aao-ss Pod.</p><p>In the top righthand corner, click the link to exec into pod</p><p>Using the Kubernetes command-line interface:</p><p>Get the Pod names and internal IP addresses for your project.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl get pods -o wide
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                          STATUS   IP
</span></span><span style=display:flex><span>amq-broker-operator-54d996c   Running  10.129.2.14
</span></span><span style=display:flex><span>ex-aao-ss-0                   Running  10.129.2.15
</span></span></code></pre></div><p>Access the shell for the broker Pod.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl exec --stdin --tty ex-aao-ss-0 -- /bin/bash
</span></span></code></pre></div><p>From the shell, use the artemis command to send some test messages. Specify the internal IP address of the broker Pod in the URL. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ./amq-broker/bin/artemis producer --url tcp://10.129.2.15:61616 --destination queue://demoQueue
</span></span></code></pre></div><p>The preceding command automatically creates a queue called demoQueue on the broker and sends a default quantity of 1000 messages to the queue.</p><p>You should see output that resembles the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Connection brokerURL <span style=color:#f92672>=</span> tcp://10.129.2.15:61616
</span></span><span style=display:flex><span>Producer ActiveMQQueue<span style=color:#f92672>[</span>demoQueue<span style=color:#f92672>]</span>, thread<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> Started to calculate elapsed time ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Producer ActiveMQQueue<span style=color:#f92672>[</span>demoQueue<span style=color:#f92672>]</span>, thread<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> Produced: <span style=color:#ae81ff>1000</span> messages
</span></span><span style=display:flex><span>Producer ActiveMQQueue<span style=color:#f92672>[</span>demoQueue<span style=color:#f92672>]</span>, thread<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> Elapsed time in second : <span style=color:#ae81ff>3</span> s
</span></span><span style=display:flex><span>Producer ActiveMQQueue<span style=color:#f92672>[</span>demoQueue<span style=color:#f92672>]</span>, thread<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> Elapsed time in milli second : <span style=color:#ae81ff>3492</span> milli seconds
</span></span></code></pre></div><p>For a complete configuration reference for the main broker Custom Resource (CR), see Broker Custom Resource configuration reference.</p><h3 id=deploying-clustered-brokers>Deploying clustered brokers</h3><p>If there are two or more broker Pods running in your project, the Pods automatically form a broker cluster. A clustered configuration enables brokers to connect to each other and redistribute messages as needed, for load balancing.</p><p>The following procedure shows you how to deploy clustered brokers. By default, the brokers in this deployment use on demand load balancing, meaning that brokers will forward messages only to other brokers that have matching consumers.</p><p>Prerequisites</p><ol><li>A basic broker instance is already deployed. See Deploying a basic broker instance.</li></ol><p>Open the CR file that you used for your basic broker deployment.</p><p>For a clustered deployment, ensure that the value of deploymentPlan.size is 2 or greater. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>broker.amq.io/v2alpha4</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ActiveMQArtemis</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ex-aao</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>application</span>: <span style=color:#ae81ff>ex-aao-app</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#ae81ff>7.7.0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>deploymentPlan</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>size</span>: <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#f92672>quay.io/artemiscloud/activemq-artemis-broker-kubernetes</span>:
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>...</span>
</span></span></code></pre></div><p>Save the modified CR file.</p><p>Switch to projects namespace:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl config set-context <span style=color:#66d9ef>$(</span>kubectl config current-context<span style=color:#66d9ef>)</span> --namespace<span style=color:#f92672>=</span> &lt;project-name&gt;
</span></span></code></pre></div><p>At the command line, apply the change:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl apply -f &lt;path/to/custom-resource-instance&gt;.yaml
</span></span></code></pre></div><p>In the Kubernetes web console, additional broker Pods starts in your project, according to the number specified in your CR.
By default, the brokers running in the project are clustered.</p><p>Open the Logs tab of each Pod. The logs show that Kubernetes has established a cluster connection bridge on each broker.
Specifically, the log output includes a line like the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>targetConnector<span style=color:#f92672>=</span>ServerLocatorImpl <span style=color:#f92672>(</span>identity<span style=color:#f92672>=(</span>Cluster-connection-bridge::ClusterConnectionBridge@6f13fb88
</span></span></code></pre></div><h3 id=applying-custom-resource-changes-to-running-broker-deployments>Applying Custom Resource changes to running broker deployments</h3><p>The following are some important things to note about applying Custom Resource (CR) changes to running broker deployments:</p><ol><li><p>You cannot dynamically update the <strong>persistenceEnabled</strong> attribute in your CR. To change this attribute, scale your cluster
down to zero brokers. Delete the existing CR. Then, recreate and redeploy the CR with your changes, also specifying a deployment size.</p></li><li><p>The value of the <strong>deploymentPlan.size</strong> attribute in your CR overrides any change you make to size of your broker deployment
via the <strong>kubectl scale</strong> command. For example, suppose you use <strong>kubectl</strong> scale to change the size of a deployment from three brokers to two,
but the value of <strong>deploymentPlan.size</strong> in your CR is still 3. In this case, Kubernetes initially scales the deployment down to two brokers.
However, when the scaledown operation is complete, the Operator restores the deployment to three brokers, as specified in the CR.</p></li><li><p>As described in <a href=#deploying-the-operator-using-the-cli>Deploying the Operator using the CLI</a>, if you create a broker deployment with persistent storage (that is, by setting persistenceEnabled=true in your CR), you might need to provision Persistent Volumes (PVs) for the ArtemisCloud Operator to claim for your broker Pods. If you scale down the size of your broker deployment, the Operator releases any PVs that it previously claimed for the broker Pods that are now shut down. However, if you remove your broker deployment by deleting your CR, ArtemisCloud Operator does not release Persistent Volume Claims (PVCs) for any broker Pods that are still in the deployment when you remove it. In addition, these unreleased PVs are unavailable to any new deployment. In this case, you need to manually release the volumes. For more information, see Releasing volumes in the Kubernetes documentation.</p></li><li><p>During an active scaling event, any further changes that you apply are queued by the Operator and executed only when scaling is complete. For example, suppose that you scale the size of your deployment down from four brokers to one. Then, while scaledown is taking place, you also change the values of the broker administrator user name and password. In this case, the Operator queues the user name and password changes until the deployment is running with one active broker.</p></li><li><p>ll CR changes – apart from changing the size of your deployment, or changing the value of the expose attribute for acceptors, connectors, or the console – cause existing brokers to be restarted. If you have multiple brokers in your deployment, only one broker restarts at a time.</p></li></ol><h2 id=configuring-scheduling-preemption-and-eviction>Configuring Scheduling, Preemption and Eviction</h2><h3 id=liveness-and-readiness-probes>Liveness and Readiness Probes</h3><p>The Liveness and readiness Probes are used by Kubernetes to detect when the Broker is started and to check it is still alive.
For full documentation on this topic refer to the <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/ target=_blank>Configure Liveness, Readiness and Startup Probes</a>
chapter in the Kubernetes documentation.</p><h4 id=the-liveness-probe>The Liveness probe</h4><p>The Liveness probe is configured in the Artemis CR something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>deploymentPlan</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>size</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>placeholder</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>livenessProbe</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>5</span>
</span></span></code></pre></div><p>If no Liveness probe is configured or the handler itself is missing from a configured Liveness Probe then the Operator
will create a default TCP Probe that will check the liveness of the broker by connecting to the web Server port, the default config is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>deploymentPlan</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>livenessProbe</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>tcpSocket</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8181</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>30</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>timeoutSeconds</span>:      <span style=color:#ae81ff>5</span>,
</span></span></code></pre></div><h5 id=using-the-artemis-health-check>Using the Artemis Health Check</h5><p>you can also use the Artemis Health Checker to check that the broker is running, something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>deploymentPlan</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>livenessProbe</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>/home/jboss/amq-broker/bin/artemis </span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>check </span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>node </span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>silent</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>user</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>$AMQ_USER</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>password</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>$AMQ_PASSWORD</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>30</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>timeoutSeconds</span>:
</span></span></code></pre></div><p>By default this uses the URI of the acceptor configured with the name <strong>artemis</strong>. Since this is not configured by default
it will need configuring in the broker CR. Alternatively configure the acceptor used by passing the <strong>&ndash;acceptor</strong>
argument on the artemis check command.</p><pre><code>NOTE: $AMQ_USER and $AMQ_PASSWORD are environment variables that are configured by the Operator
</code></pre><p>You can also check the status of the broker by producing and consuming a message:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>deploymentPlan</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>livenessProbe</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>/home/jboss/amq-broker/bin/artemis</span>
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>check</span>
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>queue</span>
</span></span><span style=display:flex><span>          - --<span style=color:#ae81ff>name</span>
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>livenessqueue</span>
</span></span><span style=display:flex><span>          - --<span style=color:#ae81ff>produce</span>
</span></span><span style=display:flex><span>          - <span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>          - --<span style=color:#ae81ff>consume</span>
</span></span><span style=display:flex><span>          - <span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>          - --<span style=color:#ae81ff>silent</span>
</span></span><span style=display:flex><span>          - --<span style=color:#ae81ff>user</span>
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>$AMQ_USER</span>
</span></span><span style=display:flex><span>          - --<span style=color:#ae81ff>password</span>
</span></span><span style=display:flex><span>          - <span style=color:#ae81ff>$AMQ_PASSWORD</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>30</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>timeoutSeconds</span>:
</span></span></code></pre></div><p>The liveness queue must exist and be deployed the broker and be of type anycast with acceptable configuration, something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>broker.amq.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ActiveMQArtemisAddress</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>livenessqueue</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>activemq-artemis-operator</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>addressName</span>: <span style=color:#ae81ff>livenessqueue</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>queueConfiguration</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>purgeOnNoConsumers</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>maxConsumers</span>: -<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>durable</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>queueName</span>: <span style=color:#ae81ff>livenessqueue</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>routingType</span>: <span style=color:#ae81ff>anycast</span>
</span></span></code></pre></div><pre><code>NOTE: The livenessqueue queue above should should only be used by the livness probe.
</code></pre><h4 id=the-readiness-probe>The Readiness Probe</h4><p>As with the Liveness Probe the Readiness probe has a default probe if not configured. Unlike the readiness probe this is
a script that is shipped in the Kubernetes Image, this can be found <a href=https://github.com/artemiscloud/activemq-artemis-broker-kubernetes-image/blob/main/modules/activemq-artemis-launch/added/readinessProbe.sh target=_blank>here</a></p><p>The script will try to establish a tcp connection to each port configured in the broker.xml.</p><h3 id=tolerations>Tolerations</h3><p>It is possible to configure tolerations on tge deployed broker image . An example of a toleration would be something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>broker.amq.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ActiveMQArtemis</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>broker</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>activemq-artemis-operator</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>deploymentPlan</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>size</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tolerations</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>key</span>: <span style=color:#e6db74>&#34;example-key&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>operator</span>: <span style=color:#e6db74>&#34;Exists&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>effect</span>: <span style=color:#e6db74>&#34;NoSchedule&#34;</span>
</span></span></code></pre></div><p>The use of Taints and Tolerations is outside the scope of this document, for full documentation see the <a href=https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/ target=_blank>Kubernetes Documentation</a></p><h3 id=affinity>Affinity</h3><p>It is possible to configure Affinity for the container pods, An example of this would be:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>broker.amq.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ActiveMQArtemis</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>broker</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>activemq-artemis-operator</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>deploymentPlan</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>affinity</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>nodeAffinity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>requiredDuringSchedulingIgnoredDuringExecution</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>nodeSelectorTerms</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>matchExpressions</span>:
</span></span><span style=display:flex><span>                - <span style=color:#f92672>key</span>: <span style=color:#ae81ff>disktype</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>operator</span>: <span style=color:#ae81ff>In</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>values</span>:
</span></span><span style=display:flex><span>                    - <span style=color:#ae81ff>ssd</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>acceptors</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;artemis&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>61617</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocols</span>: <span style=color:#ae81ff>core</span>
</span></span></code></pre></div><p>Affinity is outside the scope of this document, for full documentation see the <a href=https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes-using-node-affinity/ target=_blank>Kubernetes Documentation</a></p><h3 id=labels-and-node-selectors>Labels and Node Selectors</h3><p>Labels can be added to the pods by defining them like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>broker.amq.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ActiveMQArtemis</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>broker</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>activemq-artemis-operator</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>deploymentPlan</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>location</span>: <span style=color:#e6db74>&#34;production&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>partition</span>: <span style=color:#e6db74>&#34;customerA&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>acceptors</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;artemis&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>61617</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocols</span>: <span style=color:#ae81ff>core</span>
</span></span></code></pre></div><p>It is also possible to configure a Node Selector for the container pods, this is configured like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>broker.amq.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ActiveMQArtemis</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>broker</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>activemq-artemis-operator</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>deploymentPlan</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>nodeSelector</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>location</span>: <span style=color:#e6db74>&#34;production&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>acceptors</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;artemis&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>61617</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocols</span>: <span style=color:#ae81ff>core</span>
</span></span></code></pre></div><p>labels Node Selectors are outside the scope of this document, for full documentation see the <a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/ target=_blank>Kubernetes Documentation</a></p></div></article></div></main></div><footer class="section pb-0"><div class=container><div class=row><div class="col-md-3 col-sm-3 mb-10"><ul class="list-inline social-icons"><li class=list-inline-item><a href=https://twitter.com/artemiscloudio><i class=ti-twitter-alt></i></a></li><li class=list-inline-item>twitter</li><li class=list-inline-item><a href=https://github.com/ArtemisCloud><i class=ti-github></i></a></li><li class=list-inline-item>github</li></ul></div><div class="col-md-3 col-sm-3 mb-10"><a href=https://www.redhat.com/ target=_blank><img width=250px src=/images/Logo-Red_Hat-Sponsored_By-A-Standard-RGB.png></a></div><div class="col-md-6 col-sm-6"><div class=copyright><p>Apache, Apache ActiveMQ Artemis,Artemis and associated open source project names are trademarks of the <a href=https://www.apache.org/>Apache Software Foundation</a>.</p></div></div></div></div></footer><script src=/plugins/jQuery/jquery.min.js></script>
<script src=/plugins/bootstrap/bootstrap.min.js></script>
<script src=/plugins/slick/slick.min.js></script>
<script src=/js/script.min.js></script></body></html>